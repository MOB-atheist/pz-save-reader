<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>PZ Manager</title>
        <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family: "Segoe UI", sans-serif;
                background: #1a1a1a;
                color: #eee;
                margin: 0;
                padding: 0;
            }
            .nav {
                background: #252525;
                padding: 12px 20px;
                border-bottom: 1px solid #333;
                display: flex;
                gap: 16px;
                align-items: center;
            }
            .nav a {
                color: #00a8ff;
                text-decoration: none;
                font-weight: 500;
            }
            .nav a:hover {
                text-decoration: underline;
            }
            .nav a.active {
                color: #fff;
            }
            .btn-refresh {
                margin-left: auto;
                background: #444;
                color: #eee;
                border: 1px solid #555;
                padding: 8px 14px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .btn-refresh:hover:not(:disabled) {
                background: #555;
            }
            .btn-refresh:disabled {
                opacity: 0.8;
                cursor: wait;
            }
            .btn-refresh .refresh-spinner {
                display: inline-block;
                width: 14px;
                height: 14px;
                margin-right: 6px;
                vertical-align: middle;
                border: 2px solid rgba(255,255,255,0.3);
                border-top-color: #fff;
                border-radius: 50%;
                animation: refresh-spin 0.7s linear infinite;
            }
            .btn-refresh .refresh-spinner.hidden {
                display: none;
            }
            @keyframes refresh-spin {
                to { transform: rotate(360deg); }
            }
            .page {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
            }
            .page.hidden {
                display: none;
            }
            h1 {
                margin-top: 0;
                font-size: 1.5rem;
            }
            input[type="text"] {
                padding: 12px;
                width: 100%;
                max-width: 400px;
                margin-bottom: 20px;
                background: #333;
                border: 1px solid #555;
                color: #eee;
                border-radius: 4px;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th,
            td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #333;
            }
            th {
                background: #252525;
                font-weight: 600;
            }
            tr:hover {
                background: #252525;
            }
            tr.clickable {
                cursor: pointer;
            }
            .btn-map {
                color: #00a8ff;
                text-decoration: none;
                font-weight: bold;
            }
            .btn-map:hover {
                text-decoration: underline;
            }
            .type-tag {
                background: #444;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.9em;
            }
            .btn-details {
                background: #444;
                color: #eee;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }
            .btn-details:hover {
                background: #555;
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 20px;
            }
            .modal-overlay.hidden {
                display: none;
            }
            .modal {
                background: #252525;
                border: 1px solid #444;
                border-radius: 8px;
                max-width: 90vw;
                max-height: 85vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .modal-header {
                padding: 16px 20px;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .modal-header h2 {
                margin: 0;
                font-size: 1.25rem;
            }
            .modal-close {
                background: transparent;
                border: none;
                color: #aaa;
                font-size: 1.5rem;
                cursor: pointer;
                line-height: 1;
                padding: 0 4px;
            }
            .modal-close:hover {
                color: #fff;
            }
            .modal-body {
                padding: 20px;
                overflow-y: auto;
                flex: 1;
            }
            .detail-section {
                margin-bottom: 20px;
            }
            .detail-section h3 {
                margin: 0 0 8px 0;
                font-size: 0.95rem;
                color: #aaa;
            }
            .detail-section pre,
            .detail-section ul {
                margin: 0;
                font-size: 0.9rem;
                background: #1a1a1a;
                padding: 12px;
                border-radius: 4px;
                overflow-x: auto;
            }
            .detail-section ul {
                list-style: none;
                padding-left: 12px;
            }
            .detail-section li {
                padding: 2px 0;
            }
            .raw-toggle {
                background: #333;
                border: 1px solid #555;
                color: #eee;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }
            .raw-toggle:hover {
                background: #444;
            }
            .raw-content {
                font-size: 0.75rem;
                word-break: break-all;
                max-height: 200px;
                overflow-y: auto;
            }
            .loading {
                color: #888;
            }
            .error {
                color: #e66;
            }
            .form-group {
                margin-bottom: 16px;
            }
            .form-group label {
                display: block;
                margin-bottom: 6px;
                color: #aaa;
                font-size: 0.9rem;
            }
            .form-group input {
                max-width: 100%;
            }
            .form-group .hint {
                font-size: 0.8rem;
                color: #666;
                margin-top: 4px;
            }
            .btn-primary {
                background: #00a8ff;
                color: #fff;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1rem;
            }
            .btn-primary:hover {
                background: #0090dd;
            }
            .btn-primary:disabled {
                background: #555;
                cursor: not-allowed;
            }
            .config-status {
                margin-top: 12px;
                padding: 10px;
                border-radius: 4px;
                font-size: 0.9rem;
            }
            .config-status.success {
                background: #1a3a1a;
                color: #8f8;
            }
            .config-status.error {
                background: #3a1a1a;
                color: #f88;
            }
            .input-with-browse {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-bottom: 8px;
            }
            .input-with-browse input {
                flex: 1;
                margin-bottom: 0;
            }
            .btn-browse {
                background: #444;
                color: #eee;
                border: 1px solid #555;
                padding: 12px 16px;
                border-radius: 4px;
                cursor: pointer;
                white-space: nowrap;
            }
            .btn-browse:hover {
                background: #555;
            }
            .btn-secondary {
                background: #333;
                color: #eee;
                border: 1px solid #555;
                padding: 10px 16px;
                border-radius: 4px;
                cursor: pointer;
            }
            .btn-secondary:hover {
                background: #444;
            }
            .browse-modal .modal-body {
                min-height: 300px;
            }
            .browse-path {
                font-size: 0.9rem;
                color: #aaa;
                margin: 0 0 12px 0;
                word-break: break-all;
            }
            .browse-list {
                border: 1px solid #444;
                border-radius: 4px;
                max-height: 280px;
                overflow-y: auto;
                margin-bottom: 16px;
                background: #1a1a1a;
            }
            .browse-list .browse-entry {
                padding: 10px 12px;
                cursor: pointer;
                border-bottom: 1px solid #252525;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .browse-list .browse-entry:last-child {
                border-bottom: none;
            }
            .browse-list .browse-entry:hover {
                background: #252525;
            }
            .browse-list .browse-entry.folder::before {
                content: "üìÅ ";
            }
            .browse-list .browse-entry.file::before {
                content: "üìÑ ";
            }
            .browse-actions {
                display: flex;
                gap: 12px;
            }
            .file-input-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
            }
            .file-input-row .file-name {
                color: #888;
                font-size: 0.9rem;
            }
            .upload-status {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 12px;
                padding: 10px 12px;
                background: #1a1a1a;
                border-radius: 4px;
                font-size: 0.9rem;
                color: #aaa;
            }
            .upload-status.hidden {
                display: none;
            }
            .upload-status-spinner {
                display: inline-block;
                width: 18px;
                height: 18px;
                border: 2px solid rgba(255,255,255,0.2);
                border-top-color: #00a8ff;
                border-radius: 50%;
                animation: upload-spin 0.7s linear infinite;
            }
            .upload-status.success .upload-status-spinner {
                display: none;
            }
            @keyframes upload-spin {
                to { transform: rotate(360deg); }
            }
            .config-current {
                background: #1a1a1a;
                padding: 12px;
                border-radius: 4px;
                margin-bottom: 20px;
                font-size: 0.85rem;
            }
            .config-current h3 {
                margin: 0 0 8px 0;
                font-size: 0.9rem;
                color: #aaa;
            }
            .export-bar {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .export-bar span {
                color: #888;
                font-size: 0.9rem;
            }
            .btn-export {
                background: #444;
                color: #eee;
                border: 1px solid #555;
                padding: 8px 14px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .btn-export:hover:not(:disabled) {
                background: #555;
            }
            .btn-export:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        </style>
    </head>
    <body>
        <nav class="nav">
            <a href="#/vehicles" id="nav-vehicles">Vehicles</a>
            <a href="#/players" id="nav-players">Players</a>
            <a href="#/settings" id="nav-settings">Settings</a>
            <button type="button" class="btn-refresh" id="nav-refresh" title="Resync data from game files"><span class="refresh-spinner hidden" id="refresh-spinner" aria-hidden="true"></span><span id="refresh-label">Refresh</span></button>
        </nav>

        <main id="app">
            <div id="page-vehicles" class="page">
                <h1>Vehicles</h1>
                <input type="text" id="search-vehicles" placeholder="Filter by type (e.g. Trailer, Ambulance)..." />
                <div class="export-bar">
                    <span>Export filtered:</span>
                    <button type="button" class="btn-export" id="export-vehicles-csv">CSV</button>
                    <button type="button" class="btn-export" id="export-vehicles-excel">Excel</button>
                    <button type="button" class="btn-export" id="export-vehicles-json">JSON</button>
                    <span id="export-vehicles-msg" class="hidden" style="color:#888;"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Vehicle Type</th>
                            <th>X</th>
                            <th>Y</th>
                            <th>Map</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="vehicle-list"></tbody>
                </table>
            </div>
            <div id="page-players" class="page hidden">
                <h1>Players</h1>
                <input type="text" id="search-players" placeholder="Filter by name, username or profession..." />
                <div class="export-bar">
                    <span>Export filtered:</span>
                    <button type="button" class="btn-export" id="export-players-csv">CSV</button>
                    <button type="button" class="btn-export" id="export-players-excel">Excel</button>
                    <button type="button" class="btn-export" id="export-players-json">JSON</button>
                    <span id="export-players-msg" class="hidden" style="color:#888;"></span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Profession</th>
                            <th>Position (X, Y)</th>
                            <th>Map</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="player-list"></tbody>
                </table>
            </div>
            <div id="page-settings" class="page hidden">
                <h1>Global configuration</h1>
                <p style="color: #888; margin-bottom: 20px;">Choose your Project Zomboid save files with the file picker, or enter a save folder path below and save.</p>
                <div class="config-current" id="config-current">
                    <h3>Current paths</h3>
                    <p id="config-current-body">Loading‚Ä¶</p>
                </div>
                <form id="config-form">
                    <div class="form-group">
                        <label>Choose files (opens your file browser) or enter paths</label>
                        <div class="file-input-row input-with-browse">
                            <input type="text" id="config-vehicles-path" placeholder="Path to vehicles.db (optional)" />
                            <input type="file" id="file-vehicles" accept=".db" style="display: none" />
                            <button type="button" class="btn-browse" id="trigger-vehicles">Choose vehicles.db</button>
                            <span class="file-name" id="file-vehicles-name"></span>
                        </div>
                        <div class="file-input-row input-with-browse">
                            <input type="text" id="config-players-path" placeholder="Path to players.db (optional)" />
                            <input type="file" id="file-players" accept=".db" style="display: none" />
                            <button type="button" class="btn-browse" id="trigger-players">Choose players.db</button>
                            <span class="file-name" id="file-players-name"></span>
                        </div>
                        <div class="hint">Type a path or use the button to pick a file. Use Save configuration to apply paths.</div>
                        <div id="upload-status" class="upload-status hidden">
                            <span class="upload-status-spinner" id="upload-status-spinner" aria-hidden="true"></span>
                            <span id="upload-status-msg"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="config-save-folder">Or: Save folder path (alternative)</label>
                        <div class="input-with-browse">
                            <input type="text" id="config-save-folder" placeholder="e.g. C:\Users\You\Zomboid\Saves\Multiplayer\servertest" />
                            <input type="file" id="file-folder" webkitdirectory directory style="display: none" />
                            <button type="button" class="btn-browse" id="trigger-save-folder" title="Choose folder (opens file browser)">Choose folder</button>
                        </div>
                        <div class="hint">Pick a folder with the button (uploads vehicles.db and players.db, then syncs) or type a path and click Save configuration.</div>
                    </div>
                    <button type="submit" class="btn-primary" id="config-save-btn">Save configuration</button>
                </form>
                <div id="config-status" class="config-status hidden"></div>
            </div>
        </main>

        <div id="modal-overlay" class="modal-overlay hidden">
            <div class="modal">
                <div class="modal-header">
                    <h2 id="modal-title">Details</h2>
                    <button type="button" class="modal-close" id="modal-close" aria-label="Close">&times;</button>
                </div>
                <div class="modal-body" id="modal-body"></div>
            </div>
        </div>

        <script>
            const $ = (id) => document.getElementById(id);
            let allVehicles = [];
            let allPlayers = [];

            // Routing
            function showPage(page) {
                document.querySelectorAll(".page").forEach((p) => p.classList.add("hidden"));
                const pages = { vehicles: "page-vehicles", players: "page-players", settings: "page-settings" };
                const el = pages[page] ? $(pages[page]) : $("page-vehicles");
                if (el) el.classList.remove("hidden");
                $("nav-vehicles").classList.toggle("active", page === "vehicles");
                $("nav-players").classList.toggle("active", page === "players");
                $("nav-settings").classList.toggle("active", page === "settings");
                if (page === "vehicles") {
                    if (allVehicles.length === 0) loadVehicles();
                    else updateExportVehiclesState();
                }
                if (page === "players") {
                    if (allPlayers.length === 0) loadPlayers();
                    else updateExportPlayersState();
                }
                if (page === "settings") loadConfigPage();
            }

            window.addEventListener("hashchange", () => {
                const hash = (window.location.hash || "#/vehicles").slice(1);
                if (hash === "/players") showPage("players");
                else if (hash === "/settings") showPage("settings");
                else showPage("vehicles");
            });
            const initialHash = (window.location.hash || "#/vehicles").slice(1);
            if (initialHash === "/players") showPage("players");
            else if (initialHash === "/settings") showPage("settings");
            else showPage("vehicles");

            // Refresh: resync from game files, then reload lists
            $("nav-refresh").addEventListener("click", async () => {
                const btn = $("nav-refresh");
                const spinner = $("refresh-spinner");
                const label = $("refresh-label");
                btn.disabled = true;
                spinner.classList.remove("hidden");
                label.textContent = "Syncing‚Ä¶";
                try {
                    const res = await fetch("/api/sync", { method: "POST" });
                    const text = await res.text();
                    const data = text ? (function () { try { return JSON.parse(text); } catch (_) { return {}; } })() : {};
                    if (!res.ok) {
                        const msg = data.error || (res.status + " " + res.statusText) || "Request failed";
                        throw new Error(msg);
                    }
                    allVehicles = [];
                    allPlayers = [];
                    await loadVehicles();
                    await loadPlayers();
                    label.textContent = "Refreshed!";
                    setTimeout(() => { label.textContent = "Refresh"; }, 2000);
                } catch (err) {
                    label.textContent = "Refresh";
                    alert("Refresh failed: " + (err.message || "Unknown error"));
                } finally {
                    btn.disabled = false;
                    spinner.classList.add("hidden");
                    if (label.textContent !== "Refreshed!") label.textContent = "Refresh";
                }
            });

            // Settings / Config page
            async function loadConfigPage() {
                try {
                    const res = await fetch("/api/config");
                    if (!res.ok) throw new Error(res.statusText);
                    const cfg = await res.json();
                    $("config-save-folder").value = cfg.saveFolder || "";
                    $("config-vehicles-path").value = cfg.vehiclesDbPathOverride || "";
                    $("config-players-path").value = cfg.playersDbPathOverride || "";
                    $("config-current-body").innerHTML = "Vehicles: " + escapeHtml(cfg.vehiclesDbPath) + "<br>Players: " + escapeHtml(cfg.playersDbPath);
                } catch (e) {
                    $("config-current-body").textContent = "Failed to load: " + e.message;
                }
                $("config-status").classList.add("hidden");
            }

            $("config-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = $("config-save-btn");
                const status = $("config-status");
                btn.disabled = true;
                status.classList.add("hidden");
                try {
                    const saveFolder = $("config-save-folder").value.trim();
                    const vehiclesDbPath = $("config-vehicles-path").value.trim();
                    const playersDbPath = $("config-players-path").value.trim();
                    const res = await fetch("/api/config", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            saveFolder: saveFolder || undefined,
                            vehiclesDbPath: vehiclesDbPath || undefined,
                            playersDbPath: playersDbPath || undefined,
                        }),
                    });
                    if (!res.ok) throw new Error((await res.json()).error || res.statusText);
                    const cfg = await res.json();
                    $("config-current-body").innerHTML = "Vehicles: " + escapeHtml(cfg.vehiclesDbPath) + "<br>Players: " + escapeHtml(cfg.playersDbPath);
                    status.textContent = "Configuration saved. Database connections updated.";
                    status.className = "config-status success";
                    status.classList.remove("hidden");
                } catch (err) {
                    status.textContent = "Error: " + (err.message || "Failed to save");
                    status.className = "config-status error";
                    status.classList.remove("hidden");
                } finally {
                    btn.disabled = false;
                }
            });

            // Native file / folder picker: open Explorer and upload
            $("trigger-save-folder").addEventListener("click", () => $("file-folder").click());
            $("trigger-vehicles").addEventListener("click", () => $("file-vehicles").click());
            $("trigger-players").addEventListener("click", () => $("file-players").click());

            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.onload = () => {
                        const b64 = btoa(String.fromCharCode.apply(null, new Uint8Array(r.result)));
                        resolve(b64);
                    };
                    r.onerror = reject;
                    r.readAsArrayBuffer(file);
                });
            }

            /** Only pick vehicles.db and players.db from the folder; prefer root-level files. */
            function findDbFilesInFolder(files) {
                const list = Array.from(files);
                const isRoot = (f) => {
                    const parts = (f.webkitRelativePath || f.name || "").split("/");
                    return parts.length === 2 && (parts[1] === "vehicles.db" || parts[1] === "players.db");
                };
                const rootVehicles = list.find((f) => f.name && f.name.toLowerCase() === "vehicles.db" && isRoot(f));
                const rootPlayers = list.find((f) => f.name && f.name.toLowerCase() === "players.db" && isRoot(f));
                const anyVehicles = list.find((f) => f.name && f.name.toLowerCase() === "vehicles.db");
                const anyPlayers = list.find((f) => f.name && f.name.toLowerCase() === "players.db");
                return {
                    vehiclesFile: rootVehicles || anyVehicles,
                    playersFile: rootPlayers || anyPlayers,
                };
            }

            async function uploadFromFolder(files) {
                const { vehiclesFile, playersFile } = findDbFilesInFolder(files);
                if (!vehiclesFile || !playersFile) {
                    alert("Folder must contain both vehicles.db and players.db. Only these two files are used.");
                    return;
                }
                const statusEl = $("upload-status");
                const msgEl = $("upload-status-msg");
                const vehiclesNameEl = $("file-vehicles-name");
                const playersNameEl = $("file-players-name");
                statusEl.classList.remove("hidden", "success");
                msgEl.textContent = "Uploading vehicles.db and players.db‚Ä¶";
                vehiclesNameEl.textContent = "";
                playersNameEl.textContent = "";
                try {
                    const [vB64, pB64] = await Promise.all([fileToBase64(vehiclesFile), fileToBase64(playersFile)]);
                    msgEl.textContent = "Uploading vehicles.db‚Ä¶";
                    const vRes = await fetch("/api/upload/vehicles", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: vB64 }),
                    });
                    const vData = await vRes.json().catch(() => ({}));
                    if (!vRes.ok) throw new Error(vData.error || vRes.statusText);
                    msgEl.textContent = "Uploading players.db‚Ä¶";
                    const pRes = await fetch("/api/upload/players", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: pB64 }),
                    });
                    const pData = await pRes.json().catch(() => ({}));
                    if (!pRes.ok) throw new Error(pData.error || pRes.statusText);
                    msgEl.textContent = "Syncing tables‚Ä¶";
                    const syncRes = await fetch("/api/sync", { method: "POST" });
                    const syncData = await syncRes.json().catch(() => ({}));
                    if (!syncRes.ok) {
                        msgEl.textContent = "Saved. Sync failed.";
                    } else {
                        msgEl.textContent = "Finished.";
                    }
                    statusEl.classList.add("success");
                    vehiclesNameEl.textContent = "vehicles.db ‚úì";
                    playersNameEl.textContent = "players.db ‚úì";
                    loadConfigPage();
                    setTimeout(() => {
                        statusEl.classList.add("hidden");
                        statusEl.classList.remove("success");
                    }, 2500);
                } catch (err) {
                    statusEl.classList.add("hidden");
                    vehiclesNameEl.textContent = "";
                    playersNameEl.textContent = "";
                    alert("Failed: " + (err.message || "Unknown error"));
                }
            }

            $("file-folder").addEventListener("change", (e) => {
                const files = e.target.files;
                if (files && files.length) uploadFromFolder(files);
                e.target.value = "";
            });

            async function uploadDbFile(file, endpoint, nameEl) {
                if (!file) return;
                const statusEl = $("upload-status");
                const spinnerEl = $("upload-status-spinner");
                const msgEl = $("upload-status-msg");
                statusEl.classList.remove("hidden", "success");
                msgEl.textContent = "Uploading‚Ä¶";
                nameEl.textContent = "";
                let base64;
                try {
                    base64 = await fileToBase64(file);
                } catch (err) {
                    statusEl.classList.add("hidden");
                    alert("Failed to read file: " + (err.message || "Unknown error"));
                    return;
                }
                try {
                    const res = await fetch(endpoint, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: base64 }),
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) throw new Error(data.error || res.statusText);
                    msgEl.textContent = "Syncing tables‚Ä¶";
                    const syncRes = await fetch("/api/sync", { method: "POST" });
                    const syncData = await syncRes.json().catch(() => ({}));
                    if (!syncRes.ok) {
                        msgEl.textContent = "Saved. Upload both files to sync tables.";
                    } else {
                        msgEl.textContent = "Finished.";
                    }
                    statusEl.classList.add("success");
                    nameEl.textContent = file.name + " ‚úì";
                    loadConfigPage();
                    setTimeout(() => {
                        statusEl.classList.add("hidden");
                        statusEl.classList.remove("success");
                    }, 2500);
                } catch (err) {
                    statusEl.classList.add("hidden");
                    nameEl.textContent = "";
                    alert("Failed: " + (err.message || "Unknown error"));
                }
            }

            $("file-vehicles").addEventListener("change", (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) { e.target.value = ""; return; }
                if (!file.name || !file.name.toLowerCase().endsWith(".db")) {
                    alert("Please select a .db file (e.g. vehicles.db).");
                    e.target.value = "";
                    return;
                }
                uploadDbFile(file, "/api/upload/vehicles", $("file-vehicles-name"));
                e.target.value = "";
            });
            $("file-players").addEventListener("change", (e) => {
                const file = e.target.files && e.target.files[0];
                if (!file) { e.target.value = ""; return; }
                if (!file.name || !file.name.toLowerCase().endsWith(".db")) {
                    alert("Please select a .db file (e.g. players.db).");
                    e.target.value = "";
                    return;
                }
                uploadDbFile(file, "/api/upload/players", $("file-players-name"));
                e.target.value = "";
            });

            // Vehicles
            async function loadVehicles() {
                try {
                    const res = await fetch("/api/vehicles");
                    if (!res.ok) throw new Error(res.statusText);
                    allVehicles = await res.json();
                    renderVehicles(allVehicles);
                    updateExportVehiclesState();
                } catch (e) {
                    $("vehicle-list").innerHTML = '<tr><td colspan="6" class="error">Failed to load: ' + e.message + "</td></tr>";
                }
            }

            function renderVehicles(data) {
                const list = $("vehicle-list");
                list.innerHTML = data
                    .map(
                        (v) => `
                    <tr class="clickable" data-id="${v.id}" data-type="vehicle">
                        <td>${v.id}</td>
                        <td><span class="type-tag">${escapeHtml(v.type)}</span></td>
                        <td>${v.x != null ? v.x : "‚Äî"}</td>
                        <td>${v.y != null ? v.y : "‚Äî"}</td>
                        <td>${v.x != null && v.y != null ? '<a class="btn-map" href="https://map.projectzomboid.com/#' + v.x + 'x' + v.y + '" target="_blank">Open Map</a>' : "‚Äî"}</td>
                        <td><button type="button" class="btn-details" data-id="${v.id}" data-type="vehicle">Details</button></td>
                    </tr>
                `
                    )
                    .join("");
            }

            $("search-vehicles").addEventListener("input", (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allVehicles.filter((v) => v.type.toLowerCase().includes(term));
                renderVehicles(filtered);
                updateExportVehiclesState();
            });

            function getFilteredVehicles() {
                const term = ($("search-vehicles").value || "").trim().toLowerCase();
                return term ? allVehicles.filter((v) => v.type.toLowerCase().includes(term)) : allVehicles;
            }

            function getFilteredPlayers() {
                const term = ($("search-players").value || "").trim().toLowerCase();
                return term
                    ? allPlayers.filter(
                          (p) =>
                              (p.name && p.name.toLowerCase().includes(term)) ||
                              (p.username && p.username.toLowerCase().includes(term)) ||
                              (p.profession && p.profession.toLowerCase().includes(term))
                      )
                    : allPlayers;
            }

            function updateExportVehiclesState() {
                const data = getFilteredVehicles();
                const empty = !data.length;
                $("export-vehicles-csv").disabled = empty;
                $("export-vehicles-excel").disabled = empty;
                $("export-vehicles-json").disabled = empty;
                const msg = $("export-vehicles-msg");
                if (empty) {
                    msg.textContent = "No rows to export.";
                    msg.classList.remove("hidden");
                } else {
                    msg.textContent = "";
                    msg.classList.add("hidden");
                }
            }

            function updateExportPlayersState() {
                const data = getFilteredPlayers();
                const empty = !data.length;
                $("export-players-csv").disabled = empty;
                $("export-players-excel").disabled = empty;
                $("export-players-json").disabled = empty;
                const msg = $("export-players-msg");
                if (empty) {
                    msg.textContent = "No rows to export.";
                    msg.classList.remove("hidden");
                } else {
                    msg.textContent = "";
                    msg.classList.add("hidden");
                }
            }

            function downloadBlob(blob, filename) {
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            function csvEscape(val) {
                const s = val == null ? "" : String(val);
                if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            }

            function exportVehiclesCsv() {
                const data = getFilteredVehicles();
                if (!data.length) return;
                const rows = data.map((v) => ({
                    id: v.id,
                    type: v.type,
                    x: v.x,
                    y: v.y,
                    mapUrl: v.x != null && v.y != null ? "https://map.projectzomboid.com/#" + v.x + "x" + v.y : "",
                }));
                const headers = ["id", "type", "x", "y", "mapUrl"];
                const line = (row) => headers.map((h) => csvEscape(row[h])).join(",");
                const csv = "\uFEFF" + headers.join(",") + "\n" + rows.map(line).join("\n");
                downloadBlob(new Blob([csv], { type: "text/csv;charset=utf-8" }), "vehicles.csv");
            }

            function exportVehiclesJson() {
                const data = getFilteredVehicles();
                if (!data.length) return;
                const rows = data.map((v) => ({
                    id: v.id,
                    type: v.type,
                    x: v.x,
                    y: v.y,
                    mapUrl: v.x != null && v.y != null ? "https://map.projectzomboid.com/#" + v.x + "x" + v.y : "",
                }));
                downloadBlob(
                    new Blob([JSON.stringify(rows, null, 2)], { type: "application/json" }),
                    "vehicles.json"
                );
            }

            function exportVehiclesExcel() {
                const data = getFilteredVehicles();
                if (!data.length) return;
                if (typeof XLSX === "undefined") {
                    alert("Excel export requires SheetJS. Check your connection.");
                    return;
                }
                const rows = data.map((v) => ({
                    id: v.id,
                    type: v.type,
                    x: v.x,
                    y: v.y,
                    mapUrl: v.x != null && v.y != null ? "https://map.projectzomboid.com/#" + v.x + "x" + v.y : "",
                }));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Vehicles");
                const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
                downloadBlob(new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), "vehicles.xlsx");
            }

            function exportPlayersCsv() {
                const data = getFilteredPlayers();
                if (!data.length) return;
                const rows = data.map((p) => ({
                    id: p.id,
                    name: p.name,
                    username: p.username || "",
                    profession: p.profession || "",
                    x: p.x,
                    y: p.y,
                    z: p.z,
                    mapUrl: p.x != null && p.y != null ? "https://map.projectzomboid.com/#" + p.x + "x" + p.y : "",
                }));
                const headers = ["id", "name", "username", "profession", "x", "y", "z", "mapUrl"];
                const line = (row) => headers.map((h) => csvEscape(row[h])).join(",");
                const csv = "\uFEFF" + headers.join(",") + "\n" + rows.map(line).join("\n");
                downloadBlob(new Blob([csv], { type: "text/csv;charset=utf-8" }), "players.csv");
            }

            function exportPlayersJson() {
                const data = getFilteredPlayers();
                if (!data.length) return;
                const rows = data.map((p) => ({
                    id: p.id,
                    name: p.name,
                    username: p.username || "",
                    profession: p.profession || "",
                    x: p.x,
                    y: p.y,
                    z: p.z,
                    mapUrl: p.x != null && p.y != null ? "https://map.projectzomboid.com/#" + p.x + "x" + p.y : "",
                }));
                downloadBlob(
                    new Blob([JSON.stringify(rows, null, 2)], { type: "application/json" }),
                    "players.json"
                );
            }

            function exportPlayersExcel() {
                const data = getFilteredPlayers();
                if (!data.length) return;
                if (typeof XLSX === "undefined") {
                    alert("Excel export requires SheetJS. Check your connection.");
                    return;
                }
                const rows = data.map((p) => ({
                    id: p.id,
                    name: p.name,
                    username: p.username || "",
                    profession: p.profession || "",
                    x: p.x,
                    y: p.y,
                    z: p.z,
                    mapUrl: p.x != null && p.y != null ? "https://map.projectzomboid.com/#" + p.x + "x" + p.y : "",
                }));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Players");
                const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
                downloadBlob(new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" }), "players.xlsx");
            }

            $("export-vehicles-csv").addEventListener("click", exportVehiclesCsv);
            $("export-vehicles-excel").addEventListener("click", exportVehiclesExcel);
            $("export-vehicles-json").addEventListener("click", exportVehiclesJson);
            $("export-players-csv").addEventListener("click", exportPlayersCsv);
            $("export-players-excel").addEventListener("click", exportPlayersExcel);
            $("export-players-json").addEventListener("click", exportPlayersJson);

            // Players
            async function loadPlayers() {
                try {
                    const res = await fetch("/api/players");
                    if (!res.ok) throw new Error(res.statusText);
                    allPlayers = await res.json();
                    renderPlayers(allPlayers);
                    updateExportPlayersState();
                } catch (e) {
                    $("player-list").innerHTML = '<tr><td colspan="7" class="error">Failed to load: ' + e.message + "</td></tr>";
                }
            }

            function renderPlayers(data) {
                const list = $("player-list");
                list.innerHTML = data
                    .map(
                        (p) => `
                    <tr class="clickable" data-id="${p.id}" data-type="player">
                        <td>${p.id}</td>
                        <td>${escapeHtml(p.name)}</td>
                        <td>${escapeHtml(p.username || "‚Äî")}</td>
                        <td>${escapeHtml(p.profession || "‚Äî")}</td>
                        <td>${p.x != null && p.y != null ? p.x + ", " + p.y : "‚Äî"}</td>
                        <td>${p.x != null && p.y != null ? '<a class="btn-map" href="https://map.projectzomboid.com/#' + p.x + 'x' + p.y + '" target="_blank">Open Map</a>' : "‚Äî"}</td>
                        <td><button type="button" class="btn-details" data-id="${p.id}" data-type="player">Details</button></td>
                    </tr>
                `
                    )
                    .join("");
            }

            $("search-players").addEventListener("input", (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allPlayers.filter(
                    (p) =>
                        (p.name && p.name.toLowerCase().includes(term)) ||
                        (p.username && p.username.toLowerCase().includes(term)) ||
                        (p.profession && p.profession.toLowerCase().includes(term))
                );
                renderPlayers(filtered);
                updateExportPlayersState();
            });

            // Modal
            const overlay = $("modal-overlay");
            const modalBody = $("modal-body");
            const modalTitle = $("modal-title");

            function openModal(type, id) {
                modalTitle.textContent = type === "vehicle" ? "Vehicle " + id : "Player " + id;
                modalBody.innerHTML = '<p class="loading">Loading‚Ä¶</p>';
                overlay.classList.remove("hidden");

                const url = type === "vehicle" ? "/api/vehicles/" + id : "/api/players/" + id;
                fetch(url)
                    .then((r) => {
                        if (!r.ok) throw new Error(r.statusText);
                        return r.json();
                    })
                    .then((data) => {
                        if (type === "vehicle") {
                            modalBody.innerHTML = renderVehicleDetail(data);
                        } else {
                            modalBody.innerHTML = renderPlayerDetail(data);
                        }
                        bindRawToggle();
                    })
                    .catch((e) => {
                        modalBody.innerHTML = '<p class="error">Failed to load: ' + escapeHtml(e.message) + "</p>";
                    });
            }

            function renderVehicleDetail(data) {
                const e = data.extracted || {};
                let html = "";
                html += '<div class="detail-section"><h3>Summary</h3><ul>';
                html += "<li><strong>ID</strong>: " + data.id + "</li>";
                html += "<li><strong>Position</strong>: " + (data.x != null ? data.x : "‚Äî") + ", " + (data.y != null ? data.y : "‚Äî") + "</li>";
                html += "<li><strong>Vehicle type</strong>: " + escapeHtml(e.vehicleType || "‚Äî") + "</li>";
                if (e.partNames && e.partNames.length) {
                    html += "<li><strong>Parts</strong>: " + escapeHtml(e.partNames.join(", ")) + "</li>";
                }
                if (e.customNames && e.customNames.length) {
                    html += "<li><strong>Custom names</strong>: " + escapeHtml(e.customNames.join(", ")) + "</li>";
                }
                html += "</ul></div>";
                html += '<div class="detail-section"><button type="button" class="raw-toggle">Show raw buffer</button><pre class="raw-content hidden" id="raw-content"></pre></div>';
                window._modalRaw = data.raw || [];
                return html;
            }

            function renderPlayerDetail(data) {
                const e = data.extracted || {};
                let html = "";
                html += '<div class="detail-section"><h3>Summary</h3><ul>';
                html += "<li><strong>ID</strong>: " + data.id + "</li>";
                if (data.username) {
                    html += "<li><strong>Username</strong>: " + escapeHtml(data.username) + "</li>";
                }
                html += "<li><strong>Position</strong>: " + (data.x != null ? data.x : "‚Äî") + ", " + (data.y != null ? data.y : "‚Äî") + (data.z != null ? ", " + data.z : "") + "</li>";
                if (e.characterNames && e.characterNames.length) {
                    html += "<li><strong>Names</strong>: " + escapeHtml(e.characterNames.join(", ")) + "</li>";
                }
                if (e.professionIds && e.professionIds.length) {
                    html += "<li><strong>Profession(s)</strong>: " + escapeHtml(e.professionIds.join(", ")) + "</li>";
                }
                if (e.traitOrSkillIds && e.traitOrSkillIds.length) {
                    html += "<li><strong>Traits / skills</strong>: " + escapeHtml(e.traitOrSkillIds.slice(0, 15).join(", ")) + (e.traitOrSkillIds.length > 15 ? " ‚Ä¶" : "") + "</li>";
                }
                if (e.statNames && e.statNames.length) {
                    html += "<li><strong>Stats</strong>: " + escapeHtml(e.statNames.join(", ")) + "</li>";
                }
                html += "</ul></div>";
                html += '<div class="detail-section"><button type="button" class="raw-toggle">Show raw buffer</button><pre class="raw-content hidden" id="raw-content"></pre></div>';
                window._modalRaw = data.raw || [];
                return html;
            }

            function bindRawToggle() {
                const rawPre = document.getElementById("raw-content");
                const rawData = window._modalRaw;
                if (!rawPre || !Array.isArray(rawData)) return;
                const toggle = modalBody.querySelector(".raw-toggle");
                if (toggle) {
                    toggle.textContent = "Show raw buffer";
                    toggle.onclick = () => {
                        if (rawPre.classList.contains("hidden")) {
                            rawPre.textContent = rawData.join(", ");
                            rawPre.classList.remove("hidden");
                            toggle.textContent = "Hide raw buffer";
                        } else {
                            rawPre.classList.add("hidden");
                            toggle.textContent = "Show raw buffer";
                        }
                    };
                }
            }

            function closeModal() {
                overlay.classList.add("hidden");
            }

            $("modal-close").addEventListener("click", closeModal);
            overlay.addEventListener("click", (ev) => {
                if (ev.target === overlay) closeModal();
            });

            document.addEventListener("click", (ev) => {
                const btn = ev.target.closest(".btn-details");
                const row = ev.target.closest("tr.clickable");
                if (btn) {
                    ev.preventDefault();
                    openModal(btn.dataset.type, btn.dataset.id);
                } else if (row && !ev.target.closest("a")) {
                    ev.preventDefault();
                    openModal(row.dataset.type, row.dataset.id);
                }
            });

            function escapeHtml(s) {
                if (s == null) return "";
                const div = document.createElement("div");
                div.textContent = s;
                return div.innerHTML;
            }
        </script>
    </body>
</html>
